name: Auto Release

on:
  push:
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+"

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate tag format
        id: validate
        run: |
          TAG_NAME="${{ github.ref_name }}"
          echo "Tag name: $TAG_NAME"

          # Verify tag matches semver pattern
          if [[ ! "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "❌ ERROR: Tag $TAG_NAME does not match semantic versioning pattern"
            echo "Expected format: vX.Y.Z (e.g., v1.2.3)"
            exit 1
          fi

          VERSION="${TAG_NAME#v}"
          echo "Version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Check if release already exists
        id: check_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ github.ref_name }}"

          # Check if release already exists
          if gh release view "$TAG_NAME" >/dev/null 2>&1; then
            echo "❌ ERROR: Release for tag $TAG_NAME already exists!"
            echo "If you want to recreate the release, delete it first:"
            echo "  gh release delete $TAG_NAME"
            exit 1
          fi

          echo "✅ No existing release found for $TAG_NAME"

      - name: Generate release notes
        id: release_notes
        run: |
          TAG_NAME="${{ github.ref_name }}"
          VERSION="${{ steps.validate.outputs.version }}"

          # Get the previous tag
          PREV_TAG=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -2 | tail -1)

          if [ -z "$PREV_TAG" ]; then
            echo "No previous release found, this is the first release"
            PREV_TAG=$(git rev-list --max-parents=0 HEAD)
          fi

          echo "Generating release notes from $PREV_TAG to $TAG_NAME"

          # Generate basic release notes
          cat > release_notes.md << EOF
          ## Release $VERSION

          **Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${TAG_NAME}

          ### Artifacts

          This release includes pre-built Lambda functions for both x86_64 and ARM64 architectures:

          - \`rotel-lambda-forwarder-${TAG_NAME}_x86_64.zip\` - x86_64 architecture
          - \`rotel-lambda-forwarder-${TAG_NAME}_arm64.zip\` - ARM64 architecture

          ### CloudFormation Templates

          CloudFormation templates are available in S3:
          - \`s3://rotel-cloudformation/stacks/${TAG_NAME}/x86_64/rotel-lambda-forwarder-otlp.yaml\`
          - \`s3://rotel-cloudformation/stacks/${TAG_NAME}/x86_64/rotel-lambda-forwarder-clickhouse.yaml\`
          - \`s3://rotel-cloudformation/stacks/${TAG_NAME}/arm64/rotel-lambda-forwarder-otlp.yaml\`
          - \`s3://rotel-cloudformation/stacks/${TAG_NAME}/arm64/rotel-lambda-forwarder-clickhouse.yaml\`

          ### Installation

          Download the appropriate architecture zip file and deploy using AWS Lambda.

          For detailed deployment instructions, see the [README](https://github.com/${{ github.repository }}/blob/main/README.md).
          EOF

          echo "release_notes_file=release_notes.md" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.PAT_RELEASE_ENGINEER }}
        run: |
          TAG_NAME="${{ github.ref_name }}"
          VERSION="${{ steps.validate.outputs.version }}"

          gh release create "$TAG_NAME" \
            --title "$VERSION" \
            --notes-file "${{ steps.release_notes.outputs.release_notes_file }}" \
            --draft=false \
            --prerelease=false

          echo "✅ Successfully created release $TAG_NAME"
          echo "The release workflow will now be triggered to build and upload artifacts."
